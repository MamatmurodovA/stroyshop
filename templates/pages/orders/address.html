{% extends 'base.html' %}
{% load static %}
{% load i18n humanize %}
{% block title %}
    {% trans 'My delivery addresses' %}
{% endblock %}
{% block content %}
    {{ header }}
    <div id="main">
        {{ breadcrumbs }}
        <section id="address" style="font-size: 14px">
            <div class="col-md-4">
                <span>{% trans 'Total amount of order' %}: {{ total_amount|floatformat|intcomma }} {% trans 'sum' %}</span>
            </div>
            {% if not user.is_authenticated %}
                <div class="col-md-8">
                    <a href="{% url 'users:login' %}?next={{ request.path }}">{% trans 'Login' %}</a>
                    <h4>{% trans 'or' %} {% trans 'Continue as guest' %}</h4>
                </div>
            {% else %}
                <h4>{% trans 'My delivery addresses' %}</h4>
                <div class="block-content">
                     <div class="row add">
                        <a href="" id="add_address">{% trans 'Add an address' %}</a>
                    </div>
                    {% for address in delivery_addresses %}
                        <div class="row delivery_item">
                            <div class="default" data-is_default="{% if address.is_default %}1{% else %}0{% endif %}">
                                {% if address.is_default %}
                                    <span>{% trans 'Default' %}:</span><span>stroyshop</span>
                                {% endif %}
                            </div>
                            {% if deliveryaddress.email %}
                                <div class="email">{{ address.email }}</div>
                            {% endif %}
                            <div class="address">{{ address.address }}</div>
                            <div class="phone" data-phone="{{ address.phone }}">
                                Tel. : +998 {{ address.phone }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
            {% if form.errors %}
                {{ form.errors }}
            {% endif %}
            <div class="col-md-8">
                <form id="checkout-form" action="{% url 'orders:checkout' %}" method="post" role="form" style="display: block;">
                    {% csrf_token %}
                    <div class="form-group">
                        <input type="text" name="client_name" maxlength="60"
                               required="" id="id_client_name"
                               placeholder="{% trans 'Client name' %}"
                               value="{% if form.client_name.value %}{{ form.client_name.value }}{% elif request.user.is_authenticated %}{{ user.first_name }} {{ user.last_name }}{% endif %}"
                        >
                        {% if form.client_name.errors %}
                            <div class="help-block">
                                {{ form.client_name.errors }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <div class="input-group prefix">
                            <span class="input-group-addon">+998</span>
                            <input
                                    required
                                    type="text"
                                    name="phone"
                                    id="id_phone"
                                    class="form-control checkou-phone"
                                    placeholder="{% trans 'Phone' %}"
                                    value="{% if form.phone.value %}{{ form.phone.value }}{% endif %}"
                                    pattern="[0-9]{9}"
                                    size="9"
                                    maxlength="9"
                            >
                        </div>
                        {% if form.phone.errors %}
                            <div class="help-block">
                                {{ form.phone.errors }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <textarea
                                name="shipping_address"
                                cols="40"
                                rows="5"
                                required=""
                                id="id_shipping_address"
                                placeholder="{{ address_example }}"
                        >{% if form.shipping_address.value %}{{ form.shipping_address.value }}{% endif %}</textarea>
                        {% if form.shipping_address.errors %}
                            <div class="help-block">
                                {{ form.shipping_address.errors }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="form-actions">
                        <input
                                type="submit"
                                name="login-submit"
                                id="login-submit"
                                tabindex="4"
                                class="form-control btn btn-login"
                                value="{% trans 'Continue' %}"
                        >
                    </div>
                </form>
            </div>
        </section>
    </div>
<div id="add_popup" class="{% if form.errors %}add-address-popup{% endif %}" style="display: {% if form.errors %}block{% else %}none{% endif %}">
    <form id="delivery_address_add" method="post">
        <span class="close">x</span>
        {% csrf_token %}
        <h1>{% trans 'Add an address' %}</h1>
        <div class="form-group">
            <textarea
                    placeholder="{{ address_example }}"
                    name="{{ form_address.address.name }}"
            >{% if form_address.address.value %}{{ form_address.address.value }}{% endif %}</textarea>
            {% if form_address.address.errors %}
                {{ form_address.address.errors }}
            {% endif %}
        </div>
        <div class="form-group">
            <input
                    type="email"
                    name="{{ form_address.email.name }}"
                    placeholder="E-mail"
                    value="{% if form_address.email.value %}{{ form_address.email.value }}{% endif %}">
            {% if form.email.errors %}
                {{ form.email.errors }}
            {% endif %}
        </div>
        <div class="form-group">
            <div class="input-group prefix">
                <span class="input-group-addon">+998</span>
                <input
                        id="delivery_phone_number"
                        pattern="[0-9]{9}"
                        type="text"
                        name="{{ form_address.phone.name }}"
                        size="9"
                        maxlength="9"
                        placeholder="Phone number"
                        value="{% if form_address.phone.value %}{{ form_address.phone.value }}{% endif %}"
                >
            </div>
            {% if form_address.phone.errors %}
                {{ form_address.phone.errors }}
            {% endif %}
        </div>
        <div class="form-group">
            <input
                    type="checkbox"
                    name="{{ form_address.is_default.name }}"
            >
            <label>{% trans 'Is default' %}</label>
        </div>
        <input type="hidden" name="action_type" value="create">
        <input type="hidden" name="object_id" value="">
        {% trans 'Submit' as submit %}
        <input type="submit" name="Submit" value={{submit}}>
    </form>
</div>
    {{ footer }}
{% endblock %}
{% block js %}
   <script type="text/javascript">
        $(document).ready(function () {

            $('#add_address').click(function (e) {
                e.preventDefault();
                var add_form_block = $('#add_popup');
                    add_form_block.addClass('add-address-popup').fadeIn();
                    add_form_block.find('input[name="object_id"]').val('');
                    add_form_block.find('input[name="action_type"]').val('create');
            });
            $('#delivery_address_add span.close').click(function (e) {
                e.preventDefault();
                $('#add_popup').removeClass('add-address-popup').fadeOut();
            });

            $('.delivery_item_edit').click(function (e) {
                e.preventDefault();
                var is_default = $(this).parent('.actions').parent().find('.default').data('is_default');
                var email = $(this).parent('.actions').parent().find('.email').text().trim();
                var address = $(this).parent('.actions').parent().find('.address').text().trim();
                var phone = $(this).parent('.actions').parent().find('.phone').data('phone');
                var object_id = $(this).data('object_id');

                $('#add_popup').addClass('add-address-popup').fadeIn();

                var form = $('#delivery_address_add');

                form.find('textarea').val(address)
                form.find('input[name="email"]').val(email);
                form.find('input[name="phone"]').val(phone);
                form.find('input[name="object_id"]').val(object_id);
                form.find('input[name="action_type"]').val('update');
                if (is_default)
                {
                    form.find('input[name="is_default"]').click();
                }
            })
            $('.delivery_item').click(function (e) {
              var address = $(this).find('.address').text();
              var phone = $(this).find('.phone').data('phone');
              var checkout_form = $('#checkout-form');

              checkout_form.find('input[name="phone"]').val(phone);
              checkout_form.find('#id_shipping_address').val(address);
           });
        });
    </script>
{% endblock %}