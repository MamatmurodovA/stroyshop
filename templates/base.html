{% load static i18n %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#b7c233">
    <meta name="msapplication-navbutton-color" content="#b7c233">
    <meta name="apple-mobile-web-app-status-bar-style" content="#b7c233">
    <style type="text/css">

    .bounce {
        margin: 250px auto 0;
        width: 70px;
        text-align: center;
    }

    .bounce>div {
        width: 18px;
        height: 18px;
        background-color: #b7c233;
        border-radius: 100%;
        display: inline-block;
        animation: sk-bouncedelay 1.4s infinite ease-in-out both;
    }

    .bounce .bounce1 {
        animation-delay: -0.32s;
    }

    .bounce .bounce2 {
        animation-delay: -0.16s;
    }

    @keyframes sk-bouncedelay {
        0%,
        80%,
        100% {
            transform: scale(0);
        }
        40% {
            transform: scale(1.0);
        }
    }
    </style>
    <title>{% block title %}{% endblock %}</title>
    {% block css %}{% endblock %}

    <link rel="shortcut icon" type="image/png" href="{% static 'images/favicon.png' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'plugins/owl.theme.default.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'plugins/fontawesome/font-awesome.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/fancy.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/jquery-ui.structure.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/jquery-ui.theme.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/main.css' %}?v=123qwer1t">
    <link rel="stylesheet" type="text/css" href="{% static 'css/custom_style.css' %}?v=123qwer1t">

    <script src="{% static 'js/scripts.js' %}?v=123qwer1t"></script>
    <script src="{% static 'js/notify.min.js' %}"></script>
    <script src="{% static 'js/custom.js' %}?v=123qwer1t"></script>
    <script src="{% static 'js/main.js' %}?v=123qwer1t"></script>
    <script src="{% static 'js/js.cookie.min.js' %}"></script>
    <script src="{% static 'js/jquery-ui.min.js' %}"></script>
    <script src="https://use.fontawesome.com/1ff752e90a.js"></script>

    <style>
        .notifyjs-corner
        {
            top: 40% !important;
        }
        form ul.errorlist {
            color: red;
            margin: 6px;
            padding: 2px;
        }
        #delivery_address_add span.close {
            float: right;
            cursor: pointer;
        }
    </style>
</head>
<body class="product">
<div class="loader">
    <div class="bounce">
        <div class="bounce1"></div>
        <div class="bounce2"></div>
        <div class="bounce3"></div>
    </div>
</div>
<div id="body" style="opacity: 0;">
    {% block content %}{% endblock %}
</div>
{% block js %}{% endblock %}
<script>
window.is_mobile = function(){
    var isMobile = false; //initiate as false
// device detection
    if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)
        || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4))) {
        isMobile = true;
    }
    return isMobile;
};
window.set_data_to_cookie = function(client_name, phone, email, shipping_address, time, need_porter, payment_method)
{
    var client_data;
    if (Cookies.get('client_data'))
    {
        client_data = JSON.parse(Cookies.get('client_data'));
    }
    else
    {
        client_data = {
            "time": "",
            "need_porter": "",
            "payment_method": "",
            "address": {
                "client_name": "",
                "phone": "",
                "email": "",
                "shipping_address": ""
            }
        }
    }
    var data = {
        "time": (time)? time : client_data.time ,
        "need_porter": (need_porter)? need_porter : client_data.need_porter ,
        "payment_method": (payment_method)? payment_method : client_data.payment_method,
        "address": {
            "client_name": (client_name)? client_name : client_data.address.client_name ,
            "phone": (phone)? phone :  client_data.address.phone,
            "email": (email)? email : '' ,
            "shipping_address": (shipping_address)? shipping_address : client_data.address.shipping_address
        }
    };
    Cookies.set('client_data', JSON.stringify(data), { expires: 7, path: '/' });
};

$(document).ready(function () {
    var csrftoken = Cookies.get('csrftoken')
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    function addParameter(url, parameterName, parameterValue, atStart/*Add param before others*/){
        replaceDuplicates = true;
        if(url.indexOf('#') > 0){
            var cl = url.indexOf('#');
            urlhash = url.substring(url.indexOf('#'),url.length);
        } else {
            urlhash = '';
            cl = url.length;
        }
        sourceUrl = url.substring(0,cl);

        var urlParts = sourceUrl.split("?");
        var newQueryString = "";

        if (urlParts.length > 1)
        {
            var parameters = urlParts[1].split("&");
            for (var i=0; (i < parameters.length); i++)
            {
                var parameterParts = parameters[i].split("=");
                if (!(replaceDuplicates && parameterParts[0] === parameterName))
                {
                    if (newQueryString === "")
                        newQueryString = "?";
                    else
                        newQueryString += "&";
                    newQueryString += parameterParts[0] + "=" + (parameterParts[1]?parameterParts[1]:'');
                }
            }
        }
        if (newQueryString === "")
            newQueryString = "?";

        if(atStart){
            newQueryString = '?'+ parameterName + "=" + parameterValue + (newQueryString.length>1?'&'+newQueryString.substring(1):'');
        } else {
            if (newQueryString !== "" && newQueryString !== '?')
                newQueryString += "&";
            newQueryString += parameterName + "=" + (parameterValue?parameterValue:'');
        }
        return urlParts[0] + newQueryString + urlhash;
    }

    $('#order_by').change(function (e) {
        var href = location.href;
        var name = $(this).attr('name');
        var value = $(this).val();
        location = addParameter(href, 'order_by', value, true)
    });

    $(document).on('click', '.product_list_variation', function (elem) {

        var variation_name = $(this).data('variation_name');
        var product_id = $(this).data('product_id');

        var tmp_this = $(this);

        var product_title = $(this).parent('ul').parent('.weight').parent('.product_list_variation_list').siblings('.title');
        product_title.find('.product_variation').text($(this).children('span').text());


        if ($(this).data('color_has'))
        {
           var url = '/api/v1/products/' + product_id +'/variations/?name=' + variation_name;
           $.getJSON(url, function (resp) {
               var results = resp.results;

               var html = "";
               var color_has = 0;

               if (resp.count > 0)
               {
                   $.each(results, function (index, item) {
                       if (item.color_code)
                       {
                            color_has++;
                            var price = item.price;
                            var attr_class = (index === 0)? 'active' : '';
                            var attr_title = item.color_name;
                            var attr_max = item.quantity;
                            html += '<li  class="color_change" id="variation_' + item.id +'">';
                                html += '<span data-variation="' + item.id +'" data-quantity="' + attr_max +'"  data-title="' + attr_title + '" data-price="' + price +'" class="'+ attr_class + '" style="background-color: '+ item.color_code +'"></span>';
                            html += '</li>';
                       }
                   });
                   if(color_has  > 0)
                   {
                       var color = tmp_this.parent().parent('.weight').siblings('.color');
                       console.dir(tmp_this.data('variation_name'));
                       color.css({
                           'display': 'inline-block'
                       });
                       color.children('.colors_set').html(html);
                       color.find('.color_change>span.active').click();
                   }
               }
           });
        }
        else
        {
            var price = $(this).data('price');
            var quantity = $(this).data('quantity');

            var addtocart = tmp_this.parent().parent('.weight').parent('.product_list_variation_list').siblings('.addtocart');

            if (quantity !== 0)
            {
                    addtocart.show();
                var quantity_input = addtocart.find('.product_cart_add_form input[name="quantity"]');
                    quantity_input.prop('max', $(this).data('max'));
                    quantity_input.data('variation', $(this).data('variation'));
                    addtocart.siblings('.price').find('.price_display').text(price)
                    addtocart.siblings('.price').find('.price_label').show()
            }
            else
            {
                    addtocart.hide();
                    addtocart.siblings('.price').find('.price_display').text("{% trans 'Not available' %}")
                    addtocart.siblings('.price').find('.price_label').hide()
            }
        }
    });


    $(document).on('click', '.color_change span', function (e) {
        console.log('color clicked');
        var color_change = $(this).parent('.color_change');
        var colors_set = color_change.parent('ul.colors_set');
        var addtocart = colors_set.parent('.color').parent('.product_list_variation_list').siblings('.addtocart');
        var product_title = colors_set.parent('.color').parent('.product_list_variation_list').siblings('.title');

        product_title.find('.product_color').text($(this).data('title'));

        var tmp_this = $(this);
        var price = $(this).data('price');
        var quantity = $(this).data('quantity');

        $.each(color_change.parent('ul').children('li'), function (index, item) {
            $(item).children('span').removeClass('active')
        });

        $(this).addClass('active');

        var quantity_input = addtocart.find('.product_cart_add_form input[name="quantity"]');

        if (quantity !== 0)
        {
            addtocart.show();
            quantity_input.prop('max', $(this).data('max'));
            quantity_input.data('variation', $(this).data('variation'));
            addtocart.siblings('.price').find('.price_display').text(price)
            addtocart.siblings('.price').find('.price_label').show()
        }
        else
        {
            addtocart.hide();
            addtocart.siblings('.price').find('.price_display').text("{% trans 'Not available' %}")
            addtocart.siblings('.price').find('.price_label').hide()
        }
    });


    $(document).on('click', '.delete_item', function (e) {
        var cart_item_id = $(this).data('cart_item_id');
        $.ajax({
            url: '/api/v1/cart/' + cart_item_id +'/delete/',
            type: 'DELETE',
            success: function (res) {
                $(e.target).parent().parent().parent('.product-row').hide();
                $.notify("{% trans 'Successful removed' %}", 'success');
                update_cart()
            },
            error: function (error) {
                console.log(error);
            }
        });
    });

});
function update_cart() {
    $.getJSON("{% url 'api:cart_list' %}", function(resp){
        $("#cart_price_total").text(resp.total_price);
    });

    $.get("{% url 'api:cart_html_list' %}", function(resp){
        $('#cartview').html(resp);
    });
}
window.onload = function () {

    update_cart();

    $('form.product_cart_add_form').submit(function (e) {
       var this_target = $(this);
       var this_elem = $(this);
       e.preventDefault();
       var quantity = $(this).find('input[name="quantity"]').val();
       var variation = $(this).find('input[name="quantity"]').data('variation');
       $.ajax({
           url: '{% url "api:cart_list" %}',
           type: 'POST',
           data: {
               count: quantity,
               variation: variation
           },
           success: function (resp) {
               var cart = $('#cart_icon');
               if (resp.status === 'success')
               {
                    if (window.innerWidth <= 1024)
                    {
                        cart = $('#checkout_block_order_checkout_btn');
                    }
                    cart.removeClass('rotated');

                    var top = cart.offset().top + 10;
                    var left = cart.offset().left + 10;

                    var image_src = this_target.find('button').data("image");
                    var new_imgtodrag = document.createElement('img');
                        new_imgtodrag.src = image_src;

                    var imgtodrag =  $(new_imgtodrag);

                    if (imgtodrag) {
                        var imgclone = imgtodrag.clone()
                            .offset({
                                top: this_target.offset().top,
                                left: this_target.offset().left
                            })
                            .css({
                                'opacity': '0.5',
                                'position': 'absolute',
                                'height': '150px',
                                'width': '150px',
                                'z-index': '100'
                            })
                            .appendTo($('body'))
                            .animate({
                                'top': cart.offset().top + 10,
                                'left': cart.offset().left + 10,
                                'width': 75,
                                'height': 75
                            }, 1000, 'easeInOutExpo');

                        imgclone.animate({
                            'width': 0,
                            'height': 0
                        }, function () {
                            $(this).detach()
                        });

                    }

                    setTimeout(function (e) {
                        cart.addClass('rotated');
                    }, 1000);

                   update_cart();
                   $.notify(resp.message, 'success');
               }
               else
               {
                   $.notify(resp.message, 'error');
               }
           },
           error: function () {
               console.log('Error')
           }
       })
    });

    $(document).on('change', '.change_price_cart_item', function () {
        var price = $(this).data('price');
        $(this).parent('.quantity').siblings('.price').find('.price_total').text(price);
    });


    $(document).on('click', '.order_steps ul.steps li', function(){
        window.location.href = $(this).children('a').attr('href');
    });

    $(document).on('click', '#products .product-row', function(e){
        if (is_mobile())
        {
            {#console.dir(e.target);#}
            {#$(e.target).hide()#}
        }
    });
};

$(window).load(function() {
    $('.loader').fadeOut();
    $('#body').css({ 'opacity': 1 });
});
</script>
</body>
</html>
<!-- Sentry JS SDK 2.1.+ required -->
{#<script src="https://cdn.ravenjs.com/2.3.0/raven.min.js"></script>#}

{% if request.sentry.id %}
  <script>
  Raven.showReportDialog({
    eventId: '{{ request.sentry.id }}',

    // use the public DSN (dont include your secret!)
    dsn: 'https://7d9bb4cd7a954c2f841ba88fd0eea88b:3c012f644643414e8f9e48d7148b5675@sentry.io/1198570'
  });
  </script>
{% endif %}